<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8" />
<title>Ispis uplatnice</title>

<style>
  :root{
    --sheet-margin: 8mm;   /* margina papira (podesivo) */
    --handle-size: 8px;
  }

  body{
    font-family: "Courier New", monospace;
    background:#f3f4f6;
    color:#111;
    margin:0;
    padding:0;
    user-select:none;
  }

  /* Glavni papir 168√ó100 mm */
  .sheet{
    position:relative;
    width:168mm;
    height:100mm;
    background:white;
    margin: var(--sheet-margin) auto;
    box-shadow:0 12px 25px rgba(0,0,0,.25);
    overflow:hidden;
  }

  /* Print bez margina */
  @media print{
    body{
      background:white;
    }
    @page{
      size:168mm 100mm;
      margin:0;
    }
    .no-print{display:none !important;}
    .sheet{
      margin:0 !important;
      box-shadow:none !important;
      background:white !important;
    }
  }

  /* PODESIVA POLJA */
  .fld{
    position:absolute;
    min-width:20mm;
    padding:0;
    margin:0;
    font-size:12px;
    line-height:1.1;
    white-space:nowrap;
    border:1px dashed transparent;   /* ne vidi se u normalnom radu */
  }
  .fld.editing{
    border-color:#4b9cff;
    background:rgba(100,150,255,0.06);
  }

  /* Plave toƒçkice ‚Äì resize */
  .h{
    width:var(--handle-size);
    height:var(--handle-size);
    background:#1d4ed8;
    border-radius:50%;
    position:absolute;
    cursor:pointer;
  }
  .h.br{ right:-4px; bottom:-4px; }
  .h.bl{ left:-4px;  bottom:-4px; }
  .h.tr{ right:-4px; top:-4px; }
  .h.tl{ left:-4px;  top:-4px; }

  /* Toolbar */
  #toolbar{
    position:fixed;
    top:10px; left:50%;
    transform:translateX(-50%);
    background:white;
    padding:8px 14px;
    border-radius:6px;
    box-shadow:0 3px 10px rgba(0,0,0,.2);
    z-index:2000;
    display:flex;
    align-items:center;
    gap:8px;
    font-size:13px;
  }
  #toolbar button{
    padding:4px 8px;
    font-size:13px;
    cursor:pointer;
  }
  #fontSlider{
    width:100px;
  }
</style>
</head>
<body>

<!-- alatna traka -->
<div id="toolbar" class="no-print">
  <button type="button" onclick="decMargin()">‚Äì margina</button>
  <button type="button" onclick="incMargin()">+ margina</button>

  <label>
    Font:
    <input id="fontSlider" type="range" min="8" max="18" step="1" value="12">
  </label>

  <button type="button" onclick="saveLayout()">üíæ Spremi pozicije</button>
  <button type="button" onclick="window.print()">üñ® Ispis</button>
</div>

<!-- radna povr≈°ina (papir) -->
<div id="sheet" class="sheet">

  <!-- SVA POLJA ‚Äì poƒçetne pozicije (mo≈æe≈° ih kasnije ruƒçno pomjeriti i spremiti) -->

  <div class="fld" id="f_uplatilac" style="left:10mm; top:10mm; width:70mm;">Uplatilac</div>

  <div class="fld" id="f_primatelj" style="left:10mm; top:22mm; width:70mm;">Primatelj</div>

  <div class="fld" id="f_svrha" style="left:10mm; top:34mm; width:70mm;">Svrha</div>

  <div class="fld" id="f_svrha1" style="left:10mm; top:42mm; width:70mm;">Svrha 2</div>

  <div class="fld" id="f_iznos" style="left:120mm; top:34mm; width:40mm;">Iznos</div>

  <div class="fld" id="f_racunPrim" style="left:120mm; top:22mm; width:40mm;">Raƒçun primatelja</div>

  <div class="fld" id="f_mjesto" style="left:10mm; top:55mm; width:60mm;">Mjesto, datum</div>

  <div class="fld" id="f_porezni" style="left:120mm; top:55mm; width:40mm;">Porezni</div>

  <div class="fld" id="f_opcina" style="left:120mm; top:63mm; width:40mm;">Opƒáina</div>

  <div class="fld" id="f_poziv" style="left:120mm; top:71mm; width:40mm;">Poziv na broj</div>

</div>

<script>
/* -------------------------------------------------
   GLOBALNE POSTAVKE
--------------------------------------------------*/
const GRID_PX = 2; // veliƒçina grida za snap (u px)
let selectedField = null;
const fontSlider = document.getElementById("fontSlider");

/* -------------------------------------------------
   UƒåITAVANJE PODATAKA IZ parent window (postMessage)
--------------------------------------------------*/
let payload = null;

window.addEventListener("message", (event)=>{
  if(event.data?.type === "uplatnica-data"){
    payload = event.data.payload;
    fillFields();
  }
});

function fillFields(){
  if(!payload) return;

  setText("f_uplatilac", payload.uplatilac || payload.uplatilac_tekst || "");
  setText("f_primatelj", payload.primatelj || "");
  setText("f_svrha", payload.svrha || "");
  setText("f_svrha1", payload.svrha1 || "");
  setText("f_iznos", payload.iznos_full || "");
  setText("f_racunPrim", payload.racun_primatelja || "");
  setText("f_mjesto", (payload.mjesto || "") + (payload.datum ? ", " + payload.datum : ""));
  setText("f_porezni", payload.broj_poreskog_obv || "");
  setText("f_opcina", payload.opcina_sifra || "");
  setText("f_poziv", payload.poziv_na_broj || "");
}

function setText(id, txt){
  const el = document.getElementById(id);
  if(el) el.textContent = txt;
}

/* -------------------------------------------------
   DODAVANJE HANDLES + DRAG
--------------------------------------------------*/
document.querySelectorAll(".fld").forEach(f=>{
  addHandles(f);
  makeDraggable(f);
});

function addHandles(f){
  ["tl","tr","bl","br"].forEach(pos=>{
    const h = document.createElement("div");
    h.className = "h " + pos;
    f.appendChild(h);
    h.addEventListener("mousedown", resizeStart);
  });
}

/* ---------- RESIZE ---------- */
let rTarget=null, rStartX=0, rStartWidthPx=0;

function resizeStart(e){
  e.preventDefault();
  rTarget = this.parentElement;
  const cs = getComputedStyle(rTarget);
  rStartWidthPx = parseFloat(cs.width);
  rStartX = e.clientX;

  document.addEventListener("mousemove", resizeMove);
  document.addEventListener("mouseup", resizeStop);
}

function resizeMove(e){
  if(!rTarget) return;
  const dx = e.clientX - rStartX;
  const newW = rStartWidthPx + dx;
  if(newW > 10) {
    rTarget.style.width = newW + "px";
  }
}

function resizeStop(){
  if(rTarget){
    // snap ≈°irine na grid
    const cs = getComputedStyle(rTarget);
    const w = parseFloat(cs.width);
    const wSnap = Math.round(w / GRID_PX) * GRID_PX;
    rTarget.style.width = wSnap + "px";
  }
  document.removeEventListener("mousemove", resizeMove);
  document.removeEventListener("mouseup", resizeStop);
  rTarget = null;
}

/* ---------- DRAG + SELEKCIJA ---------- */
function makeDraggable(el){
  let dragging = false;
  let ox=0, oy=0, sx=0, sy=0;

  el.addEventListener("mousedown", e=>{
    // klik na handle -> resize, ne drag
    if(e.target.classList.contains("h")) return;

    e.preventDefault();

    // selekcija polja
    selectField(el);

    const cs = getComputedStyle(el);
    ox = parseFloat(cs.left);
    oy = parseFloat(cs.top);
    sx = e.clientX;
    sy = e.clientY;

    dragging = true;
    document.addEventListener("mousemove", move);
    document.addEventListener("mouseup", stop);
  });

  function move(e){
    if(!dragging) return;
    const dx = e.clientX - sx;
    const dy = e.clientY - sy;
    el.style.left = (ox + dx) + "px";
    el.style.top  = (oy + dy) + "px";
  }

  function stop(){
    if(dragging){
      // snap na grid
      const cs = getComputedStyle(el);
      let l = parseFloat(cs.left);
      let t = parseFloat(cs.top);
      l = Math.round(l / GRID_PX) * GRID_PX;
      t = Math.round(t / GRID_PX) * GRID_PX;
      el.style.left = l + "px";
      el.style.top  = t + "px";
    }
    dragging = false;
    document.removeEventListener("mousemove", move);
    document.removeEventListener("mouseup", stop);
  }
}

/* -------------------------------------------------
   SELEKCIJA POLJA + SLIDER FONT SIZE
--------------------------------------------------*/
function selectField(el){
  if(selectedField === el) return;

  if(selectedField){
    selectedField.classList.remove("editing");
  }
  selectedField = el;
  if(selectedField){
    selectedField.classList.add("editing");

    // postavi slider na trenutni font selektiranog polja
    const cs = getComputedStyle(selectedField);
    const fs = parseFloat(cs.fontSize) || 12;
    fontSlider.value = Math.round(fs);
  }
}

// klik bilo gdje na polje takoƒëer ga selektira (i bez pomjeranja)
document.querySelectorAll(".fld").forEach(f=>{
  f.addEventListener("click", e=>{
    if(e.target.classList.contains("h")) return;
    selectField(f);
  });
});

// promjena fonta sa slidera
fontSlider.addEventListener("input", ()=>{
  if(!selectedField) return;
  const v = parseInt(fontSlider.value, 10) || 12;
  selectedField.style.fontSize = v + "px";
});

/* -------------------------------------------------
   MARGINE PAPIRA
--------------------------------------------------*/
function incMargin(){
  const cs = getComputedStyle(document.documentElement);
  const cur = parseFloat(cs.getPropertyValue("--sheet-margin")) || 0;
  const next = cur + 1;
  document.documentElement.style.setProperty("--sheet-margin", next + "mm");
  saveMargin();
}
function decMargin(){
  const cs = getComputedStyle(document.documentElement);
  const cur = parseFloat(cs.getPropertyValue("--sheet-margin")) || 0;
  const next = Math.max(0, cur - 1);
  document.documentElement.style.setProperty("--sheet-margin", next + "mm");
  saveMargin();
}
function saveMargin(){
  const cs = getComputedStyle(document.documentElement);
  const cur = cs.getPropertyValue("--sheet-margin");
  try{
    localStorage.setItem("uplatnica-margin", cur);
  }catch(e){}
}
(function loadMargin(){
  try{
    const m = localStorage.getItem("uplatnica-margin");
    if(m) document.documentElement.style.setProperty("--sheet-margin", m);
  }catch(e){}
})();

/* -------------------------------------------------
   SPREMANJE / UƒåITAVANJE LAYOUTA
--------------------------------------------------*/
function saveLayout(){
  const obj = {};
  document.querySelectorAll(".fld").forEach(f=>{
    const cs = getComputedStyle(f);
    obj[f.id] = {
      left: cs.left,
      top: cs.top,
      width: cs.width,
      fontSize: cs.fontSize
    };
  });
  try{
    localStorage.setItem("uplatnica-layout", JSON.stringify(obj));
    alert("Pozicije i fontovi spremljeni.");
  }catch(e){
    alert("Ne mogu spremiti layout: " + e.message);
  }
}

(function loadLayout(){
  let raw = null;
  try{
    raw = localStorage.getItem("uplatnica-layout");
  }catch(e){}
  if(!raw) return;
  try{
    const obj = JSON.parse(raw);
    Object.keys(obj).forEach(id=>{
      const f = document.getElementById(id);
      if(!f) return;
      const cfg = obj[id];
      if(cfg.left) f.style.left = cfg.left;
      if(cfg.top) f.style.top = cfg.top;
      if(cfg.width) f.style.width = cfg.width;
      if(cfg.fontSize) f.style.fontSize = cfg.fontSize;
    });
  }catch(e){}
})();
</script>
</body>
</html>
