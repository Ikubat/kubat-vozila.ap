<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Ispis uplatnice</title>

<style>
  :root {
    --sheet-width-mm: 210;
    --sheet-height-mm: 150;
  }

  @page {
    margin: 8mm 10mm 8mm 10mm;
  }

  * { box-sizing: border-box; }

  body {
    font-family: "Courier New", monospace;
    font-size: 12pt;
    margin: 0;
    color: #1f2937;
    background: #f5f5f5;
  }

  #wrap {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 16px;
    padding: 16px;
    align-items: start;
  }

  #toolbar {
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }

  #toolbar h1 {
    margin: 0 0 8px;
    font-size: 18px;
  }

  #toolbar p {
    margin: 0 0 10px;
    font-size: 13px;
    color: #4b5563;
  }

  #status {
    margin: 0 0 12px;
    font-size: 13px;
    padding: 8px 10px;
    border-radius: 6px;
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
    display: none;
  }
  #status.ok {
    background: #ecfdf3;
    border-color: #bbf7d0;
    color: #166534;
  }

  .controls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 10px;
    margin-bottom: 12px;
  }

  label {
    display: flex;
    flex-direction: column;
    font-size: 13px;
    gap: 6px;
    color: #111827;
  }

  input, select {
    padding: 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 14px;
    font-family: inherit;
  }

  input[type="number"] {
    width: 100%;
  }

  .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  button {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid #9ca3af;
    background: #fff;
    cursor: pointer;
    font-family: inherit;
  }

  button.primary {
    background: #2563eb;
    color: #fff;
    border-color: #1d4ed8;
  }

  button.danger {
    background: #dc2626;
    color: #fff;
    border-color: #b91c1c;
  }

  #previewWrap {
    background: #e5e7eb;
    padding: 12px;
    border-radius: 8px;
  }

  #preview {
    position: relative;
    width: calc(var(--sheet-width-mm) * 1mm);
    height: calc(var(--sheet-height-mm) * 1mm);
    margin: 0 auto;
    background: #fff;
    border: 1px solid #d1d5db;
    overflow: hidden;
  }

  #preview::after {
    content: "";
    position: absolute;
    inset: 0;
    pointer-events: none;
    border: 1px dashed rgba(0,0,0,0.05);
    background-image: linear-gradient(to right, rgba(0,0,0,0.04) 1px, transparent 1px),
                      linear-gradient(to bottom, rgba(0,0,0,0.04) 1px, transparent 1px);
    background-size: 10mm 10mm;
  }

  .field {
    position: absolute;
    white-space: pre-wrap;
    cursor: move;
    border-radius: 4px;
    padding: 2px 4px;
    max-width: 120mm;
    line-height: 1.2;
  }

  .field.selected {
    outline: 1px dashed #2563eb;
    background: rgba(37, 99, 235, 0.08);
  }

  .field .hint {
    display: none;
  }

  .ghost {
    position: absolute;
    border: 1px dashed #9ca3af;
    background: rgba(148, 163, 184, 0.12);
    pointer-events: none;
  }

  @media print {
    body {
      margin: 0;
      padding: 0;
      background: #fff;
    }

    #wrap {
      display: block;
      margin: 0;
      padding: 0;
    }

    #toolbar {
      display: none;
    }

    #previewWrap {
      padding: 0;
      background: transparent;
      display: flex;
      justify-content: center;
    }

    #preview {
      border: none;
    }

    /* Očuvaj vidljivost sadržaja u printu i ukloni pomoćne stilove. */
    #preview, #preview * {
      visibility: visible;
    }

    .field {
      padding: 0;
      outline: none;
      background: transparent;
      cursor: default;
    }
  }
</style>
</head>
<body>

<div id="wrap">
  <div id="previewWrap">
    <div id="preview">
      <div id="uplatioc"     class="field" data-field="uplatioc"></div>
      <div id="uplatioc_txt" class="field" data-field="uplatioc_txt"></div>
      <div id="primatelj"    class="field" data-field="primatelj"></div>
      <div id="svrha1"       class="field" data-field="svrha1"></div>
      <div id="svrha2"       class="field" data-field="svrha2"></div>
      <div id="iznos"        class="field" data-field="iznos"></div>
      <div id="racunPrim"    class="field" data-field="racunPrim"></div>
      <div id="racunPos"     class="field" data-field="racunPos"></div>
      <div id="pozivNaBroj"  class="field" data-field="pozivNaBroj"></div>
      <div id="brojPoreski"  class="field" data-field="brojPoreski"></div>
      <div id="vrstaPrihoda" class="field" data-field="vrstaPrihoda"></div>
      <div id="opcina"       class="field" data-field="opcina"></div>
      <div id="budzetska"    class="field" data-field="budzetska"></div>
      <div id="mjesto"       class="field" data-field="mjesto"></div>
      <div id="datum"        class="field" data-field="datum"></div>
      <div id="napomena"     class="field" data-field="napomena"></div>
    </div>
  </div>

  <div id="toolbar">
    <h1>Podešavanje ispisa uplatnice</h1>
    <p>Povuci polje na željenu poziciju ili koristi unos u milimetrima. Podešena širina i veličina teksta pomažu da sadržaj stane na obrazac.</p>
    <p id="status" role="status"></p>

    <div class="controls">
      <label>
        Polje
        <select id="fieldSelect"></select>
      </label>
      <label>
        Veličina teksta (pt)
        <input id="fontSize" type="number" min="6" max="24" step="0.5">
      </label>
      <label>
        Širina (mm)
        <input id="width" type="number" min="10" max="160" step="1">
      </label>
      <label>
        Gornja margina (mm)
        <input id="top" type="number" min="0" max="200" step="0.5">
      </label>
      <label>
        Lijeva margina (mm)
        <input id="left" type="number" min="0" max="200" step="0.5">
      </label>
      <label>
        Deblji tekst
        <select id="weight">
          <option value="normal">Normal</option>
          <option value="bold">Bold</option>
        </select>
      </label>
    </div>

    <div class="actions">
      <button id="resetLayout" class="danger" type="button">Vrati početne pozicije</button>
      <button id="printNow" class="primary" type="button">Print</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $preview      = document.getElementById('preview');
  const $fieldSelect  = document.getElementById('fieldSelect');
  const $fontSize     = document.getElementById('fontSize');
  const $width        = document.getElementById('width');
  const $top          = document.getElementById('top');
  const $left         = document.getElementById('left');
  const $weight       = document.getElementById('weight');
  const $reset        = document.getElementById('resetLayout');
  const $printNow     = document.getElementById('printNow');
  const $status       = document.getElementById('status');

  const defaultLayout = {
    uplatioc:    { top: 18, left: 10, fontSize: 12, width: 90, weight: 'normal' },
    uplatioc_txt:{ top: 24, left: 10, fontSize: 10.5, width: 90, weight: 'normal' },
    primatelj:   { top: 38, left: 10, fontSize: 12, width: 90, weight: 'bold' },
    svrha1:      { top: 52, left: 10, fontSize: 11, width: 120, weight: 'normal' },
    svrha2:      { top: 57, left: 10, fontSize: 11, width: 120, weight: 'normal' },
    iznos:       { top: 70, left: 140, fontSize: 12, width: 60, weight: 'bold' },
    racunPrim:   { top: 84, left: 10, fontSize: 11, width: 120, weight: 'normal' },
    racunPos:    { top: 96, left: 10, fontSize: 11, width: 120, weight: 'normal' },
    pozivNaBroj: { top: 84, left: 140, fontSize: 11, width: 55, weight: 'normal' },
    brojPoreski: { top: 96, left: 140, fontSize: 10.5, width: 55, weight: 'normal' },
    vrstaPrihoda:{ top: 106, left: 140, fontSize: 10.5, width: 55, weight: 'normal' },
    opcina:      { top: 116, left: 140, fontSize: 10.5, width: 55, weight: 'normal' },
    budzetska:   { top: 126, left: 140, fontSize: 10.5, width: 55, weight: 'normal' },
    mjesto:      { top: 110, left: 10, fontSize: 11, width: 60, weight: 'normal' },
    datum:       { top: 110, left: 75, fontSize: 11, width: 40, weight: 'normal' },
    napomena:    { top: 130, left: 10, fontSize: 10.5, width: 180, weight: 'normal' }
  };

  const layoutKey = 'uplatnica-print-layout-v2';
  let layout = loadLayout();
  let selectedField = 'uplatioc';
  let dragState = null;
  let hasData = false;
  let autoPrinted = false;

  const fields = {};
  document.querySelectorAll('.field').forEach(el => {
    const name = el.dataset.field;
    if (!name) return;
    fields[name] = el;
    el.addEventListener('mousedown', e => startDrag(e, name));
    el.addEventListener('click', () => selectField(name));
  });

  Object.keys(fields).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = labelFor(name);
    $fieldSelect.appendChild(opt);
  });

  $fieldSelect.addEventListener('change', e => selectField(e.target.value));
  $fontSize.addEventListener('input', () => updateField('fontSize', parseFloat($fontSize.value)));
  $width.addEventListener('input', () => updateField('width', parseFloat($width.value)));
  $top.addEventListener('input', () => updateField('top', parseFloat($top.value)));
  $left.addEventListener('input', () => updateField('left', parseFloat($left.value)));
  $weight.addEventListener('change', () => updateField('weight', $weight.value));
  $reset.addEventListener('click', () => { layout = JSON.parse(JSON.stringify(defaultLayout)); applyLayout(); saveLayout(); });
  $printNow.addEventListener('click', () => {
    if (!hasData) {
      $status.textContent = 'Podaci za ispis još nisu učitani. Pričekajte da stignu ili pokušajte ponovo.';
      $status.classList.remove('ok');
      $status.style.display = 'block';
      return;
    }

    triggerPrint();
  });

  function labelFor(name) {
    const labels = {
      uplatioc: 'Uplatilac',
      uplatioc_txt: 'Uplatilac – dodatni tekst',
      primatelj: 'Primatelj',
      svrha1: 'Svrha (prvi red)',
      svrha2: 'Svrha (drugi red)',
      iznos: 'Iznos',
      racunPrim: 'Račun primatelja',
      racunPos: 'Račun pošiljaoca',
      pozivNaBroj: 'Poziv na broj',
      brojPoreski: 'Broj poreskog obveznika',
      vrstaPrihoda: 'Vrsta prihoda (šifra)',
      opcina: 'Općina (šifra)',
      budzetska: 'Budžetska org. (šifra)',
      mjesto: 'Mjesto',
      datum: 'Datum',
      napomena: 'Napomena'
    };
    return labels[name] || name;
  }

  function loadLayout() {
    try {
      const raw = localStorage.getItem(layoutKey);
      if (raw) {
        const parsed = JSON.parse(raw);
        return { ...defaultLayout, ...parsed };
      }
    } catch (err) {
      console.warn('Ne mogu učitati spremljene pozicije', err);
    }
    return JSON.parse(JSON.stringify(defaultLayout));
  }

  function saveLayout() {
    try {
      localStorage.setItem(layoutKey, JSON.stringify(layout));
    } catch (err) {
      console.warn('Spremanje izgleda nije uspjelo', err);
    }
  }

  function pxToMm(px) {
    const mm = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--sheet-width-mm'));
    const pxPerMm = $preview.getBoundingClientRect().width / mm;
    return px / pxPerMm;
  }

  function applyLayout() {
    Object.keys(fields).forEach(name => {
      const cfg = layout[name] || defaultLayout[name];
      const el = fields[name];
      if (!cfg || !el) return;
      el.style.top = cfg.top + 'mm';
      el.style.left = cfg.left + 'mm';
      el.style.fontSize = (cfg.fontSize || 12) + 'pt';
      el.style.width = (cfg.width || 80) + 'mm';
      el.style.fontWeight = cfg.weight || 'normal';
    });
    refreshInputs();
  }

  function refreshInputs() {
    const cfg = layout[selectedField];
    $fieldSelect.value = selectedField;
    $fontSize.value = cfg.fontSize;
    $width.value = cfg.width;
    $top.value = cfg.top;
    $left.value = cfg.left;
    $weight.value = cfg.weight;
    highlightSelected();
  }

  function selectField(name) {
    if (!fields[name]) return;
    selectedField = name;
    refreshInputs();
  }

  function updateField(key, value) {
    if (!(selectedField in layout)) return;
    if (Number.isFinite(value) || typeof value === 'string') {
      layout[selectedField][key] = value;
      applyLayout();
      saveLayout();
    }
  }

  function highlightSelected() {
    Object.keys(fields).forEach(name => {
      fields[name].classList.toggle('selected', name === selectedField);
    });
  }

  function startDrag(e, name) {
    selectField(name);
    const rect = $preview.getBoundingClientRect();
    const elRect = fields[name].getBoundingClientRect();
    dragState = {
      name,
      startX: e.clientX,
      startY: e.clientY,
      offsetX: e.clientX - elRect.left,
      offsetY: e.clientY - elRect.top,
      previewLeft: rect.left,
      previewTop: rect.top
    };
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', endDrag);
    e.preventDefault();
  }

  function onDrag(e) {
    if (!dragState) return;
    const { name, previewLeft, previewTop, offsetX, offsetY } = dragState;
    const previewRect = $preview.getBoundingClientRect();
    const x = e.clientX - previewLeft - offsetX;
    const y = e.clientY - previewTop - offsetY;
    const clampedX = Math.max(0, Math.min(x, previewRect.width - fields[name].offsetWidth));
    const clampedY = Math.max(0, Math.min(y, previewRect.height - fields[name].offsetHeight));
    layout[name].left = parseFloat(pxToMm(clampedX).toFixed(1));
    layout[name].top  = parseFloat(pxToMm(clampedY).toFixed(1));
    applyLayout();
  }

  function endDrag() {
    dragState = null;
    saveLayout();
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', endDrag);
  }

  // --- RENDER PODATAKA ---
  const $uplatioc     = document.getElementById('uplatioc');
  const $uplatiocTxt  = document.getElementById('uplatioc_txt');
  const $primatelj    = document.getElementById('primatelj');
  const $svrha1       = document.getElementById('svrha1');
  const $svrha2       = document.getElementById('svrha2');
  const $iznos        = document.getElementById('iznos');
  const $racunPrim    = document.getElementById('racunPrim');
  const $racunPos     = document.getElementById('racunPos');
  const $pozivNaBroj  = document.getElementById('pozivNaBroj');
  const $brojPoreski  = document.getElementById('brojPoreski');
  const $vrstaPrihoda = document.getElementById('vrstaPrihoda');
  const $opcina       = document.getElementById('opcina');
  const $budzetska    = document.getElementById('budzetska');
  const $mjesto       = document.getElementById('mjesto');
  const $datum        = document.getElementById('datum');
  const $napomena     = document.getElementById('napomena');

  function render(u) {
    if (!u) {
      hasData = false;
      updateStatus('Nema dostupnih podataka za ispis. Provjerite da je prozor otvoren s ispravnim ID-em.');
      return;
    }

    // Dozvoli sendere koji šalju `data` ili `payload` čvor.
    if (u && typeof u === 'object') {
      u = u.data || u.payload || u;
    }

    const pick = (...vals) => {
      for (const v of vals) {
        if (v === null || v === undefined) continue;
        const s = typeof v === 'string' ? v.trim() : v;
        if (s !== '' && s !== null && s !== undefined) return s;
      }
      return '';
    };

    $uplatioc.innerText    = pick(u.uplatilac, u.uplatilac_naziv, u.uplatilacNaziv, u.uplatilac_label);
    $uplatiocTxt.innerText = pick(u.uplatilac_tekst, u.uplatilacTekst, u.uplatilac_txt);
    $primatelj.innerText   = pick(u.primatelj, u.primatelj_naziv, u.primateljNaziv, u.primatelj_label);
    $svrha1.innerText      = pick(u.svrha, u.svrha_uplate, u.svrhaUplate, u.svrha_tekst);
    $svrha2.innerText      = pick(u.svrha1, u.svrha_2, u.svrha2, u.svrha_dodatno);

    const valuta = pick(u.valuta, 'KM') || 'KM';
    const iznosVal = pick(u.iznos, u.iznos_value, u.iznosValue);
    const iznosNum = typeof iznosVal === 'number'
      ? iznosVal
      : (iznosVal ? parseFloat(String(iznosVal).replace(',', '.')) : NaN);
    const iznos = Number.isFinite(iznosNum) ? iznosNum.toFixed(2) : pick(iznosVal, '');
    const iznosFull = pick(u.iznos_full, u.iznosFull);
    $iznos.innerText     = iznosFull || ((iznos ? iznos + ' ' : '') + valuta);
    $racunPrim.innerText = pick(u.racun_primatelja, u.racunPrim, u.racun_primaoca);
    $racunPos.innerText  = pick(u.racun_posiljaoca, u.racunPos, u.racun_platioca);
    $pozivNaBroj.innerText = pick(u.poziv_na_broj, u.pozivNaBroj, u.poziv);
    $brojPoreski.innerText = pick(u.broj_poreskog_obv, u.brojPoreski, u.porezni_broj);
    $vrstaPrihoda.innerText = pick(u.vrsta_prihoda_sifra, u.vrstaPrihoda);
    $opcina.innerText = pick(u.opcina_sifra, u.opcina);
    $budzetska.innerText = pick(u.budzetska_org_sifra, u.budzetska);
    $mjesto.innerText = pick(u.mjesto, u.mjesto_uplate, u.mjestoUplate);
    $datum.innerText = pick(u.datum, u.datum_uplate, u.datumUplate);
    $napomena.innerText = pick(u.napomena);

    hasData = Object.values(fields).some(el => (el.textContent || '').trim() !== '');
    updateStatus();

    if (hasData && !autoPrinted) {
      autoPrinted = true;
      // Automatski pokreni print kad prvi put stignu podaci da se izbjegne prazna stranica.
      triggerPrint();
    }
  }

  function triggerPrint() {
    requestAnimationFrame(() => {
      requestAnimationFrame(() => window.print());
    });
  }

  function updateStatus(customText) {
    if (!$status) return;
    if (hasData) {
      $status.textContent = customText || 'Podaci za ispis su učitani.';
      $status.classList.add('ok');
      $status.style.display = 'block';
      $printNow.disabled = false;
    } else {
      $status.textContent = customText || 'Podaci za ispis još nisu stigli. Provjerite da je prozor dopušten da učita payload ili pokušajte ponovo.';
      $status.classList.remove('ok');
      $status.style.display = 'block';
      $printNow.disabled = true;
    }
  }

  applyLayout();
  updateStatus('Učitavanje podataka za ispis…');

  // Slušaj podatke poslano preko postMessage (print iz modala "nova" / "uredi")
  let payloadPrimljen = false;
  const payloadTimer = setTimeout(() => {
    if (!payloadPrimljen && !parsedId && !storagePayload) {
      alert('Nedostaje ID uplatnice.');
    }
  }, 1500);

  window.addEventListener('message', e => {
    const data = e.data;
    if (!data) return;

    if (data.type === 'uplatnica-data') {
      payloadPrimljen = true;
      clearTimeout(payloadTimer);
      render(data.payload || data);
    }
  });

  // Preuzmi payload iz localStorage ako je poslan preko hash parametra
  const hashParams = new URLSearchParams(location.hash.replace(/^#/, ''));
  const storageKey = hashParams.get('payload');
  let storagePayload = null;
  if (storageKey) {
    try {
      const raw = localStorage.getItem(storageKey);
      if (raw) {
        storagePayload = JSON.parse(raw);
        render(storagePayload);
        payloadPrimljen = true;
        localStorage.removeItem(storageKey);
      }
    } catch (err) {
      console.warn('Ne mogu pročitati podatke iz localStorage', err);
    }
  }

  // Dobavi ID iz URL-a (podržava i hash #id=... kao fallback)
  const search = new URLSearchParams(location.search);
  const parsedId = parseInt(search.get('id') || hashParams.get('id') || hashParams.get('uplatnica_id'), 10);
  if (!parsedId) return;

  (async function(){
    const id = parsedId;

    // Odredi bazni API root (/api/ kada smo u /app/)
    const apiBase = location.pathname.includes('/app/') ? '../api/' : './api/';

    // Povuci podatke sa API-a
    let res;
    try {
      res = await fetch(apiBase + 'uplatnica_get.php?id=' + encodeURIComponent(id));
    } catch (err) {
      return alert('Greška pri dohvaćanju uplatnice (#' + id + ')');
    }

    if (!res.ok) {
      return alert('Greška pri dohvaćanju uplatnice (#' + id + ')');
    }

    let out;
    try {
      out = await res.json();
    } catch (err) {
      return alert('Neispravan odgovor sa servera (#' + id + ')');
    }

    const u = out && (out.data || out);
    if (!u || !u.id) {
      return alert('Uplatnica nije pronađena (#' + id + ')');
    }

    if (!payloadPrimljen) {
      render(u);
    }
  })();
})();
</script>

</body>
</html>