<!doctype html>
<html lang="hr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Marke – jednostavno (bez baze)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  :root{--gap:12px;--radius:14px;--shadow:0 6px 24px rgba(0,0,0,.08)}
  *{box-sizing:border-box}
  body{margin:0;padding:24px;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:#f6f7fb;color:#0c1222}
  .wrap{max-width:1000px;margin:0 auto}
  .card{background:#fff;border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
  h1{margin:0 0 8px}
  .toolbar{display:flex;gap:10px;align-items:center;margin:12px 0 16px}
  .toolbar .grow{flex:1}
  input[type="text"], select{width:100%;padding:10px 12px;border:1px solid #d4d8e1;border-radius:10px;background:#fff;outline:none}
  input:focus, select:focus{border-color:#6a7cff;box-shadow:0 0 0 3px rgba(106,124,255,.15)}
  button{border:0;border-radius:12px;padding:10px 14px;cursor:pointer}
  .btn{background:#0f68ff;color:#fff}
  .btn.sec{background:#eef2ff;color:#0f2b6b}
  .btn.warn{background:#ffe7e7;color:#9d1515}
  .list{display:grid;gap:10px}
  .head-row,.row{display:grid;gap:10px;align-items:center;background:#fff;border:1px solid #e8ecf5;border-radius:12px;padding:10px 12px}
  .head-row{font-weight:600;background:#f2f5ff}
  .head-row,.row{grid-template-columns:2fr 2fr 2fr auto}
  .acts{display:flex;gap:8px;justify-content:flex-end}
  .act{border:0;background:#eef2ff;color:#0f2b6b;padding:8px 10px;border-radius:10px;cursor:pointer}
  .act.del{background:#ffe7e7;color:#9d1515}
  .hint{padding:18px;text-align:center;color:#6b7280}
  /* Modal */
  .modal{position:fixed;inset:0;background:rgba(11,15,25,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
  .modal.show{display:flex}
  .box{max-width:720px;width:min(720px,100%);background:#fff;border-radius:16px;box-shadow:var(--shadow);padding:18px}
  .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .grid{display:grid;gap:12px}
  .grid.two{grid-template-columns:repeat(2,1fr)}
  @media(max-width:820px){.grid.two{grid-template-columns:1fr}}
  .msg{display:none;color:#9d1515;background:#ffe7e7;border:1px solid #ffc8c8;padding:8px 10px;border-radius:8px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Marke</h1>
      <div class="toolbar">
        <div class="grow"><input id="q" type="text" placeholder="Traži po marki / modelu / vrsti…"></div>
        <button id="btnAddTop" class="btn"><i class="fa fa-plus"></i> Nova marka</button>
      </div>

      <div id="list" class="list">
        <div class="head-row">
          <div>Vrsta</div><div>Marka</div><div>Model</div><div style="text-align:right">Akcije</div>
        </div>
      </div>
      <div id="empty" class="hint" hidden>Nema rezultata.</div>
    </div>
  </div>

  <!-- MODAL: Nova/Uredi marka -->
  <div id="mWrap" class="modal" role="dialog" aria-modal="true" aria-labelledby="mTitle">
    <div class="box">
      <header>
        <h2 id="mTitle">Nova marka</h2>
        <button id="mClose" class="btn sec" type="button">✕</button>
      </header>
      <div class="grid two">
        <div><label>Marka *<br><input id="m_naziv" type="text" required></label></div>
        <div><label>Model *<br><input id="m_model" type="text" required></label></div>
        <div>
          <label>Vrsta *<br>
            <select id="m_vrsta"><option value="">— odaberi vrstu —</option></select>
          </label>
          <div style="margin-top:6px">
            <button id="btnAddVrsta" class="btn sec" type="button"><i class="fa fa-plus"></i> Nova vrsta</button>
          </div>
        </div>
        <div><input id="m_id" type="hidden"></div>
      </div>
      <div id="mMsg" class="msg">Poruka</div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
        <button id="mSave" class="btn" type="button"><i class="fa fa-floppy-disk"></i> Spremi</button>
        <button id="mCancel" class="btn sec" type="button">Odustani</button>
      </div>
    </div>
  </div>

  <!-- MINI MODAL: Nova vrsta -->
  <div id="dlgVrsta" class="modal" role="dialog" aria-modal="true" aria-labelledby="vTitle">
    <div class="box">
      <header>
        <h2 id="vTitle">Nova vrsta</h2>
        <button id="vClose2" class="btn sec" type="button">✕</button>
      </header>
      <div class="grid two">
        <div><label>Naziv vrste *<br><input id="v_naziv2" type="text" required></label></div>
        <div><label>Oznaka<br><input id="v_oznaka2" type="text"></label></div>
      </div>
      <div id="vMsg2" class="msg">Poruka</div>
      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:14px">
        <button id="vSave2" class="btn" type="button"><i class="fa fa-floppy-disk"></i> Spremi</button>
        <button id="vCancel2" class="btn sec" type="button">Odustani</button>
      </div>
    </div>
  </div>

<script>
(function(){
  // --- “Baza” u LocalStorage-u ---
  const K_VRSTE = 'app_vrste';
  const K_MARKE = 'app_marke';

  const esc = s => String(s??'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const byId = id => document.getElementById(id);
  const show = (el,on)=>{ if(!el) return; el.hidden = !on; };

  // UI refs
  const $list   = byId('list');
  const $empty  = byId('empty');
  const $q      = byId('q');
  const $btnAdd = byId('btnAddTop');

  // modal Marka
  const $mWrap=byId('mWrap'), $mTitle=byId('mTitle'), $mId=byId('m_id'),
        $mNaz=byId('m_naziv'), $mMod=byId('m_model'), $mVrs=byId('m_vrsta'),
        $mMsg=byId('mMsg'), $mSave=byId('mSave'), $mCancel=byId('mCancel'), $mClose=byId('mClose');

  // mini modal Vrsta
  const $dlgV=byId('dlgVrsta'), $btnAddVrsta=byId('btnAddVrsta'),
        $vNaz=byId('v_naziv2'), $vOzn=byId('v_oznaka2'), $vMsg=byId('vMsg2'),
        $vSave=byId('vSave2'), $vCancel=byId('vCancel2'), $vClose=byId('vClose2');

  // --- storage helperi ---
  function load(key, def){ try{ const v = JSON.parse(localStorage.getItem(key)); return Array.isArray(v)?v:(v||def);}catch{return def;}}
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

  // --- inicijalni podaci ako prazno ---
  function ensureSeed(){
    let vrste = load(K_VRSTE, []);
    let marke = load(K_MARKE, []);
    if(vrste.length===0){
      vrste = [
        {id:1, naziv:'Automobil', oznaka:'AUTO'},
        {id:2, naziv:'Kombi',      oznaka:'KOM'},
        {id:3, naziv:'Kamion',     oznaka:'KAM'},
        {id:4, naziv:'Motocikl',   oznaka:'MOT'},
        {id:5, naziv:'Radna mašina',oznaka:'RM'}
      ];
      save(K_VRSTE, vrste);
    }
    if(marke.length===0){
      marke = [
        {id:1, naziv:'Volkswagen', model:'Golf 7', vrsta_id:1},
        {id:2, naziv:'Renault',    model:'Trafic', vrsta_id:2},
      ];
      save(K_MARKE, marke);
    }
  }

  // --- rendering ---
  function renderList(filter=''){
    const marke = load(K_MARKE, []);
    const vrste = load(K_VRSTE, []);
    const mapVrste = new Map(vrste.map(v=>[String(v.id), v]));

    const q = filter.trim().toLowerCase();
    const rows = marke.filter(m=>{
      const v = mapVrste.get(String(m.vrsta_id));
      const vrstaTxt = v ? `${v.naziv} ${v.oznaka||''}`.toLowerCase() : '';
      const s = `${m.naziv} ${m.model} ${vrstaTxt}`.toLowerCase();
      return q==='' || s.includes(q);
    });

    // header ostaje, brišemo stare redove
    $$('.row').forEach(el=>el.remove());

    if(rows.length===0){
      show($empty,true);
      return;
    }
    show($empty,false);

    const html = rows.map(m=>{
      const v = mapVrste.get(String(m.vrsta_id));
      const vrsta = v ? `${esc(v.naziv)}${v.oznaka?(' ('+esc(v.oznaka)+')'):''}` : '';
      return `
        <div class="row" data-id="${m.id}">
          <div>${vrsta}</div>
          <div>${esc(m.naziv)}</div>
          <div>${esc(m.model)}</div>
          <div class="acts">
            <button class="act edit"><i class="fa fa-pen"></i></button>
            <button class="act del"><i class="fa fa-trash"></i></button>
          </div>
        </div>
      `;
    }).join('');
    $list.insertAdjacentHTML('beforeend', html);
  }

  function fillVrste(preselectId){
    const vrste = load(K_VRSTE, []).slice().sort((a,b)=>String(a.naziv).localeCompare(String(b.naziv),'hr'));
    $mVrs.innerHTML = '<option value="">— odaberi vrstu —</option>' +
      vrste.map(v=>`<option value="${v.id}">${esc(v.naziv)}${v.oznaka?(' ('+esc(v.oznaka)+')'):''}</option>`).join('');
    if(preselectId) $mVrs.value = String(preselectId);
  }

  // --- modal marka ---
  function openNew(){
    $mTitle.textContent='Nova marka';
    $mId.value=''; $mNaz.value=''; $mMod.value='';
    fillVrste('');
    $mMsg.style.display='none';
    $mWrap.classList.add('show'); $mNaz.focus();
  }
  function openEdit(row){
    const id = +row.dataset.id;
    const marke = load(K_MARKE, []);
    const m = marke.find(x=>x.id===id);
    if(!m) return;
    $mTitle.textContent='Uredi marku';
    $mId.value = m.id;
    $mNaz.value = m.naziv;
    $mMod.value = m.model;
    fillVrste(m.vrsta_id||'');
    $mMsg.style.display='none';
    $mWrap.classList.add('show'); $mNaz.focus();
  }
  function closeMarka(){ $mWrap.classList.remove('show'); }

  // --- mini modal vrsta ---
  function openVrsta(){
    $vMsg.style.display='none'; $vMsg.textContent='';
    $vNaz.value=''; $vOzn.value='';
    $dlgV.classList.add('show'); $vNaz.focus();
  }
  function closeVrsta(){ $dlgV.classList.remove('show'); }

  // --- CRUD (LocalStorage) ---
  function saveMarka(data){
    const marke = load(K_MARKE, []);
    if(data.id){ // update
      const i = marke.findIndex(x=>x.id===data.id);
      if(i>=0) marke[i] = data;
    }else{ // create
      const maxId = marke.reduce((a,x)=>Math.max(a,x.id),0);
      data.id = maxId+1;
      marke.push(data);
    }
    save(K_MARKE, marke);
  }
  function deleteMarka(id){
    let marke = load(K_MARKE, []);
    marke = marke.filter(x=>x.id!==id);
    save(K_MARKE, marke);
  }
  function createVrsta(naziv, oznaka){
    const vrste = load(K_VRSTE, []);
    // provjeri postoji li već (po nazivu + oznaka)
    const ex = vrste.find(v=>v.naziv.toLowerCase()===naziv.toLowerCase() && (v.oznaka||'').toLowerCase()===(oznaka||'').toLowerCase());
    if(ex) return ex.id;
    const maxId = vrste.reduce((a,x)=>Math.max(a,x.id),0);
    const id = maxId+1;
    vrste.push({id, naziv, oznaka});
    save(K_VRSTE, vrste);
    return id;
  }

  // --- eventi ---
  $btnAdd.addEventListener('click', openNew);
  $mCancel.addEventListener('click', closeMarka);
  $mClose.addEventListener('click', closeMarka);
  $mWrap.addEventListener('click', e=>{ if(e.target===$mWrap) closeMarka(); });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ closeMarka(); closeVrsta(); } });

  $list.addEventListener('click', e=>{
    const row = e.target.closest('.row[data-id]');
    if(!row) return;
    if(e.target.closest('.edit')){ openEdit(row); }
    if(e.target.closest('.del')){
      const id = +row.dataset.id;
      if(confirm('Obrisati marku #'+id+' ?')){ deleteMarka(id); renderList($q.value); }
    }
  });

  $mSave.addEventListener('click', ()=>{
    const naziv = $mNaz.value.trim();
    const model = $mMod.value.trim();
    const vrstaId = $mVrs.value ? +$mVrs.value : null;
    if(!naziv || !model || !vrstaId){
      $mMsg.textContent='Naziv, Model i Vrsta su obavezni.'; $mMsg.style.display='block'; return;
    }
    const id = +($mId.value||0) || null;
    saveMarka({id, naziv, model, vrsta_id: vrstaId});
    closeMarka();
    renderList($q.value);
  });

  $btnAddVrsta.addEventListener('click', openVrsta);
  $vCancel.addEventListener('click', closeVrsta);
  $vClose.addEventListener('click', closeVrsta);
  $dlgV.addEventListener('click', e=>{ if(e.target===$dlgV) closeVrsta(); });

  $vSave.addEventListener('click', ()=>{
    const naziv = $vNaz.value.trim();
    const oznaka = ($vOzn.value||'').trim();
    if(!naziv){ $vMsg.textContent='Naziv je obavezan.'; $vMsg.style.display='block'; $vNaz.focus(); return; }
    const newId = createVrsta(naziv, oznaka);
    closeVrsta();
    // osvježi select i preselektiraj
    fillVrste(newId);
  });

  $q.addEventListener('input', ()=>renderList($q.value));

  // --- init ---
  ensureSeed();
  renderList('');
})();
</script>
</body>
</html>
